<?php
$page->title('People: Details')
     ->navbar_image('people')
     ->breadcrumbs('Search', 'Details');

class Item {
  private $person;

  public function __construct($person) {
    $this->person = $person;
  }

  public function display($label, $field, $href=NULL, $class=NULL, $group=False) {
    $displayString = "";

    foreach($this->person->getField($field) as $value) {
      // prevent phones from creating links from things that look like phone/email
	  if (strcmp($field, 'mail') != 0) {
		// We now don't want hyphens to display in an email address, but it's OK elsewhere.
      	$value = str_replace('@', '@&shy;', $value); 
	  }
      $value = str_replace('-', '-&shy;', $value);
      $value = str_replace('$', '<br />', $value);
	  if (strcmp($field, 'ou') == 0) {
	  	$value = str_replace('^', ' / ', $value);
	  }

      $innerContents = "
                 <div class=\"label\">$label</div>
                 <div class=\"value\">$value</div>";

      if ($href !== NULL) {
		  $linkAddress = $value;
		
		  if (strcmp($field, 'postaladdress') == 0) {
			// Only send the next-to-last line of the address to the map search.
			$addressLines = explode("<br />", $value);
			$lineCount = count($addressLines);
			if ($lineCount > 1) {
				$linkAddress = $addressLines[$lineCount - 2];	
			}
		  }
	
        $innerContents = '<a href="' . $href($linkAddress) . '" class="' . $class . '">'
                       . $innerContents . '</a>';
      }

      $innerContents = '<li>' . $innerContents . '</li>';

      if (!$group) {
        $innerContents = '<ul class="nav">' . $innerContents . '</ul>';
      }

      $displayString .= $innerContents;
    }
    echo $displayString;
  }
}

$item = new Item($person);

$page->content_begin();
?>
	<ul class="nav">
        <? $item->display('name', 'cn', NULL, NULL, TRUE); ?>
        <? $item->display('title', 'title', NULL, NULL, TRUE); ?>
        <? $item->display('unit', 'ou', NULL, NULL, TRUE); ?>
	</ul>
	
        <? if(has_phone($person)) { ?>
          <ul class="nav">
          <? $item->display('home', 'homephone', 'phoneHREF', 'phone', TRUE); ?>
          <? $item->display('phone', 'telephonenumber', 'phoneHREF', 'phone', TRUE); ?>
          <? $item->display('fax', 'facsimiletelephonenumber', 'phoneHREF', 'phone', TRUE); ?>
          </ul>
        <? } ?>

        <? $item->display('address', 'street', NULL, NULL, FALSE); ?>
        <? $item->display('email', 'mail', 'mailHREF', 'email', FALSE); ?>
        <? $item->display('office', 'postaladdress', 'mapURL', 'map', FALSE); ?>

<? $page->content_end(); ?>

